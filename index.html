<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			/* @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap'); */
			@import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap');

			body {
				/* font-family: 'Roboto', sans-serif; */
				font-family: 'Source Code Pro', monospace;
				font-size: 0.75rem;

				@media (min-width: 425px) {
					font-size: 1rem;
				}
			}

			.hidden {
				display: none;
			}

			h1 {
				text-align: center;
			}
			header > h3 {
				margin-bottom: 0;
			}
			h4 {
				margin: 0;
			}

			ul, ol {
				list-style-type: none;
				padding-left: 1.25em;
			}

			nav > ul {
				display: flex;
				gap: 0.5em;
				justify-content: center;
				padding-left: 0;

				> li {
					border: 1px solid black;
					border-radius: 1em;
					cursor: pointer;
					padding: 0.125em 1em;
					text-align: center;

					&.active {
						background-color: lightgray;
					}
				}
			}

			main > section > section > section {
				border: 1px solid black;
				border-radius: 1em;
				margin-bottom: 0.5em;
				padding: 0 0.5em;

				> header > h3 {
					cursor: pointer;
				}

				&.completed {
					border-color: gray;
					color: gray;

					div {
						border-color: gray;

						&.andrew {
							background-color: rgba(230, 184, 175, 0.5);
						}
						&.ben {
							background-color: rgba(201, 218, 248, 0.5);
						}
						&.brian {
							background-color: rgba(255, 242, 204, 0.5);
						}
						&.jarrod {
							background-color: rgba(217, 234, 211, 0.5);
						}
					}
				}

				&.current {
					background-color: lightgray;
				}
			}

			main li {
				display: flex;
				flex-wrap: wrap;
				gap: 0 0.5em;
				align-items: center;

				div {
					text-align: center;
				}

				.sweep {
					font-weight: bold;
				}

				.date, .result {
					width: 3.625em;
				}

				.points {
					text-align: right;
					width: 3.0625em;
				}

				.player {
					border: 1px solid black;
					border-radius: 1em;
					margin: 0.167em 0;
					width: 4.25em;
				}
				.andrew {
					background-color: #E6B8AF;
				}
				.ben {
					background-color: #C9DAF8;
				}
				.brian {
					background-color: #FFF2CC;
				}
				.jarrod {
					background-color: #D9EAD3;
				}

			}
		</style>
	</head>
	<body>
		<script>
			// API Variables
			const spreadsheetId = '1QQt2qAqi9pURIgyCKrFYc-JXCgV8PYefR9ut5KejPz4';
			const range = 'API';
			const key = 'AIzaSyADnkNWzw5wme2wHe2PQzpjm-Kv77Hsl_s';
			const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${key}`;

			fetch(url)
				.then((response) => response.json())
				.then((data) => {
					//////////////////////////////////////////////////////////////////////////////////////////////////////////////
					//																								BUILD DATA																								//
					//////////////////////////////////////////////////////////////////////////////////////////////////////////////

					// LEAGUE
					let league = data.values;
					let leagueHeader = { title: 'OMG League', players: ['Andrew', 'Ben', 'Brian', 'Jarrod'] };
					league = league.slice(1); // remove header

					// SEASONS
					let seasons = [];
					let leagueRowCount = league.length;
					let seasonRowCount = 29;
					let seasonCount = leagueRowCount / seasonRowCount;
					for (let s = 0; s < seasonCount; s++) {
						let start = s * seasonRowCount;
						let season = league.slice(start, start + seasonRowCount);
						let [setName, setCode] = season[0];
						let seasonHeader = { setName, setCode };
						season = season.slice(1); // remove header

						// ROUNDS
						let rounds = [];
						let headlessSeasonRowCount = 28;
						let roundRowCount = 7;
						let roundCount = headlessSeasonRowCount / roundRowCount;
						for (let r = 0; r < roundCount; r++) {
							let start = r * roundRowCount;
							let round = season.slice(start, start + roundRowCount);
							round = round.slice(1); // remove header

							// MATCHES

							// Build Matches
							let matches = round.map((match) => ({
								date: match[0],
								player1: match[1],
								player2: match[2],
								player1Wins: parseInt(match[3]),
								player2Wins: parseInt(match[4]),
							}));

							// Sort Matches
							matches = matches.toSorted((a, b) => {
								if (a.date && b.date) {
									return new Date(a.date) - new Date(b.date);
								} else if (a.date) {
									return -1;
								} else if (b.date) {
									return 1;
								} else {
									return 0;
								}
							});

							// Build Rounds
							rounds = [
								...rounds,
								{
									header: `Round ${r + 1}`,
									matches,

									// Round Dates
									get roundDates() {
										let dates = { start: null, end: null, length: null }; // future round

										if (matches[0].date || rounds[r - 1]?.matches.at(-1).date) {
											// past or current round
											let start;
											if (r < 1) {
												// first round
												start = matches[0].date; // first date of round
											} else {
												// not first round
												start = rounds[r - 1].matches.at(-1).date; // last date of previous round
											}

											let end;
											if (matches.at(-1).date) {
												// past round
												end = matches.at(-1).date; // last date of round
											} else {
												// current round
												end = new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit' }); // today's date
											}

											let length = Math.floor(Math.floor(new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); // length in days
											dates = { start, end, length };
										}

										return dates;
									},

									// Round Standings
									get roundStandings() {
										// Build Standings
										let players = leagueHeader.players.map((player) => {
											player = {
												name: player,
												wins: 0,
												losses: 0,
												matchPoints: 0,
												packs: 0,
											};

											matches.forEach((match) => {
												if (match.date) {
													let x, y; // player1, player2
													if (match.player1 === player.name) {
														[x, y] = ['1', '2'];
													} else if (match.player2 === player.name) {
														[x, y] = ['2', '1'];
													}

													if (x) {
														if (match[`player${x}Wins`] === 0) {
															player.losses++;
														} else if (match[`player${x}Wins`] === 1) {
															player.losses++;
															player.matchPoints++;
														} else if (match[`player${x}Wins`] === 2) {
															player.wins++;
															if (match[`player${y}Wins`] === 1) {
																player.matchPoints += 2;
															} else if (match[`player${y}Wins`] === 0) {
																player.matchPoints += 3;
															}
														}
													}
												}
											});

											return player;
										});

										// Sort Standings (MP, Head-to-Head, W-L)
										players = players.toSorted((a, b) => {
											// equal match points
											if (a.matchPoints === b.matchPoints) {
												// head-to-head tiebreaker
												let headToHead = matches.find((match) => {
													return (
														match.date &&
														((match.player1 === a.name && match.player2 === b.name) ||
															(match.player1 === b.name && match.player2 === a.name))
													);
												});
												if (headToHead) {
													let headToHeadWinner;
													if (headToHead.player1Wins > headToHead.player2Wins) {
														headToHeadWinner = headToHead.player1;
													} else if (headToHead.player2Wins > headToHead.player1Wins) {
														headToHeadWinner = headToHead.player2;
													}
													if (headToHeadWinner === a.name) {
														return -1;
													} else if (headToHeadWinner === b.name) {
														return 1;
													}
												} else {
													// W-L tiebreaker
													if (a.wins === b.wins) {
														return a.losses - b.losses;
													} else {
														return b.wins - a.wins;
													}
												}
											} else {
												return b.matchPoints - a.matchPoints;
											}
										});

										// tally packs
										if (matches.at(-1).date) {
											players = players.map((player, idx) =>
												idx < 2 ? { ...player, packs: 0 } : { ...player, packs: 1 },
											);
										}

										return players;
									},
								},
							];
						}

						// Build Seasons
						seasons = [
							...seasons,
							{
								header: seasonHeader,
								rounds,

								// Season Standings
								get seasonStandings() {
									// Build Standings
									let players = leagueHeader.players.map((player) => {
										player = {
											name: player,
											wins: 0,
											losses: 0,
											matchPoints: 0,
											packs: 0,
										};

										rounds.forEach((round) => {
											round.roundStandings.forEach((standing) => {
												if (standing.name === player.name) {
													player.wins += standing.wins;
													player.losses += standing.losses;
													player.matchPoints += standing.matchPoints;
													player.packs += standing.packs;
												}
											});
										});

										return player;
									});

									// Sort Standings (MP, W-L)
									players = players.toSorted((a, b) => {
										if (a.matchPoints === b.matchPoints) {
											// W-L tiebreaker
											if (a.wins === b.wins) {
												return a.losses - b.losses;
											} else {
												return b.wins - a.wins;
											}
										} else {
											return b.matchPoints - a.matchPoints;
										}
									});
									return players;
								},
							},
						];
					}

					// Build League
					league = { header: leagueHeader, seasons };

					// Development View
					console.dir(league);
					window.league = league;
					let leaguePre = document.createElement('pre');
					leaguePre.textContent = JSON.stringify(league, null, 2);
					// document.querySelector('body').append(leaguePre);

					//////////////////////////////////////////////////////////////////////////////////////////////////////////////
					//																								BUILD PAGE																								//
					//////////////////////////////////////////////////////////////////////////////////////////////////////////////

					/*
					//	League <body>
					//		I. League Header <header>
					//			A. League Heading <h1>
					//			B. League Navigation <nav>
					//				1. League Navigation List <ul>
					//					a... League Navigation List Item <li> ...
					//		II. League Seasons <main>
					//			A. League Season <section> ...
					//				1. Season Header <header>
					//					a. Season Heading <h2>
					//					b. Season Standings <section>
					//						i. Season Standings Heading <h3>
					//						ii. Season Standings List <ol>
					//							-... Season Standings List Item <li> ...
					//				2. Season Rounds <section>
					//					a... Season Round <section> ...
					//						i. Round Header <header>
					//							- Round Heading <h2>
					//							- Round Dates <h3>
					//						ii. Round Matches List <ul>
					//							-... Round Matches List Item <li> ...
					//						iii. Round Standings Heading <h3>
					//						iv. Round Standings List <ol>
					//							-... Round Standings List Item <li> ...
					*/

					function buildPage() {
						// League <body>
						let body = document.querySelector('body');

						// I. League Header <header>
						let leagueHeader = document.createElement('header');

						// A. League Heading <h1>
						let leagueHeading = document.createElement('h1');
						leagueHeading.textContent = league.header.title;
						leagueHeader.append(leagueHeading);

						// B. League Navigation <nav>
						let leagueNavigation = document.createElement('nav');
						leagueNavigation.addEventListener('click', (e) => {
							if (e.target.tagName === 'LI') {
								document.querySelector('nav .active').classList.remove('active');
								e.target.classList.add('active');
								let index = [...e.target.parentElement.children].indexOf(e.target);
								let seasons = [...document.querySelector('main').children];
								seasons.forEach((season) => season.classList.add('hidden'));
								seasons[index].classList.remove('hidden');
							}
						});

						// 1. League Navigation List <ul>
						let leagueNavigationList = document.createElement('ul');

						// a. League Navigations List Item(s) <li> ...
						league.seasons.forEach((season, index) => {
							let leagueNavigationListItem = document.createElement('li');
							if (index < 1) {
								leagueNavigationListItem.classList.add('active');
							}
							leagueNavigationListItem.textContent = season.header.setCode;
							leagueNavigationList.append(leagueNavigationListItem);
						});

						leagueNavigation.append(leagueNavigationList);
						leagueHeader.append(leagueNavigation);
						body.append(leagueHeader);

						// II. League Seasons <main>
						let leagueSeasons = document.createElement('main');

						// A. League Season(s) <section> ...
						league.seasons.forEach((season, index) => {
							let leagueSeason = document.createElement('section');
							if (index > 0) {
								leagueSeason.classList.add('hidden');
							}

							// 1. Season Header <header>
							let seasonHeader = document.createElement('header');

							// a. Season Heading <h2>
							let seasonHeading = document.createElement('h2');
							seasonHeading.textContent = season.header.setName;
							seasonHeader.append(seasonHeading);

							// b. Season Standings <section>
							let seasonStandings = document.createElement('section');

							// i. Season Standings Heading <h3>
							let seasonStandingsHeading = document.createElement('h3');
							seasonStandingsHeading.textContent = 'Overall Standings';
							seasonStandings.append(seasonStandingsHeading);

							// ii. Season Standings List <ol>
							let seasonStandingsList = document.createElement('ol');

							// - Season Standings List Item(s) <li> ...
							season.seasonStandings.forEach((player, idx) => {
								let seasonStandingsListItem = document.createElement('li');
								let rank = document.createElement('div');
								rank.textContent = `${idx + 1}.`;
								seasonStandingsListItem.append(rank);
								let name = document.createElement('div');
								name.textContent = player.name;
								name.classList.add('player', `${player.name.toLowerCase()}`);
								seasonStandingsListItem.append(name);
								let record = document.createElement('div');
								record.classList.add('record');
								record.textContent = `(${player.wins}-${player.losses})`;
								seasonStandingsListItem.append(record);
								let points = document.createElement('div');
								points.classList.add('points');
								points.textContent = `${player.matchPoints} MP`;
								seasonStandingsListItem.append(points);
								let packs = document.createElement('div');
								packs.textContent = player.packs ? `[+${player.packs} packs]` : '';
								seasonStandingsListItem.append(packs);
								seasonStandingsList.append(seasonStandingsListItem);
							});

							seasonStandings.append(seasonStandingsList);
							seasonHeader.append(seasonStandings);
							leagueSeason.append(seasonHeader);

							// 2. Season Rounds <section>
							let seasonRounds = document.createElement('section');

							// a. Season Round(s) <section> ...
							season.rounds.forEach((round, idx, rounds) => {
								let seasonRound = document.createElement('section');
								if (round.matches[0].date) {
									if (round.matches.at(-1).date) {
										seasonRound.classList.add('completed');
									} else {
										seasonRound.classList.add('current');
									}
								}

								// i. Round Header <header>
								let roundHeader = document.createElement('header');

								// - Round Heading <h2>
								let roundHeading = document.createElement('h2');
								roundHeading.textContent = round.header;
								roundHeader.append(roundHeading);

								// - Round Dates <h3>
								let roundDates = document.createElement('h3');
								let dates = round.roundDates;
								if (round.matches.some((match) => match.date) || rounds[idx - 1]?.matches.every((match) => match.date)) {
									if (round.matches.every((match) => match.date)) {
										roundDates.textContent = `${dates.start} - ${dates.end} (${dates.length} days)`;
									} else {
										roundDates.textContent = `${dates.start} - ... (${dates.length} days...)`;
									}
								} else {
									roundDates.textContent = '';
								}
								roundDates.addEventListener('click', event => {
									let h4s = event.target.parentElement.querySelectorAll('h4');
									[...h4s].forEach(h4 => h4.classList.toggle('hidden'));
								})
								roundHeader.append(roundDates);

								let start = dates.start;
								let end = dates.end;
								let length = dates.length;
								if (length) {
									let text = '';
									let days = [];
									round.matches.forEach((match) => {
										if (match.date) {
											let day = (new Date(match.date) - new Date(start)) / 86400000;
											days = [...days, day];
										}
									});
									for (let i = length; i > -1; i--) {
										if (days.includes(i)) {
											text = `x${text}`;
										} else {
											text = `.${text}`;
										}
									}
									text = text.match(new RegExp('.{1,' + 30 + '}', 'g'));
									text.forEach((string) => {
										let dateDots = document.createElement('h4');
										dateDots.classList.add('hidden');
										dateDots.textContent = string;
										roundHeader.append(dateDots);
									});
								}

								seasonRound.append(roundHeader);

								// ii. Rount Matches List <ul>
								let roundMatchesList = document.createElement('ul');
								let matches = [[], []];
								round.matches.forEach((match) => {
									if (match.date) {
										matches = [[...matches[0], match], matches[1]];
									} else {
										matches = [matches[0], [...matches[1], match]];
									}
								});
								matches = [matches[0].toSorted((a, b) => new Date(a.date) - new Date(b.date)), matches[1]];

								// - Round Matches List Item(s) <li> ...
								matches[0].forEach((match) => {
									let roundMatchesListItem = document.createElement('li');
									let date = document.createElement('div');
									date.classList.add('date');
									date.textContent = match.date;
									roundMatchesListItem.append(date);
									let winner = document.createElement('div');
									winner.textContent = match.player1Wins === 2 ? match.player1 : match.player2;
									winner.classList.add(
										'player',
										`${match.player1Wins === 2 ? match.player1.toLowerCase() : match.player2.toLowerCase()}`,
									);
									roundMatchesListItem.append(winner);
									let [winnerWins, loserWins] = match.player1Wins === 0 || match.player2Wins === 0 ? [2, 0] : [2, 1];
									let result = document.createElement('div');
									result.classList.add('result');
									result.textContent = `(${winnerWins}-${loserWins})`;
									if (loserWins < 1) {
										result.classList.add('sweep');
									}
									roundMatchesListItem.append(result);
									let loser = document.createElement('div');
									loser.textContent = winner.textContent === match.player1 ? match.player2 : match.player1;
									loser.classList.add(
										'player',
										`${
											winner.textContent === match.player1 ? match.player2.toLowerCase() : match.player1.toLowerCase()
										}`,
									);
									roundMatchesListItem.append(loser);
									let points = document.createElement('div');
									points.textContent = loserWins < 1 ? 'MP (3-0)' : 'MP (2-1)';
									roundMatchesListItem.append(points);
									roundMatchesList.append(roundMatchesListItem);
								});
								matches[1].forEach((match) => {
									let roundMatchesListItem = document.createElement('li');
									let spacer = document.createElement('div');
									if (matches[0].length) {
										spacer.classList.add('date');
									}
									roundMatchesListItem.append(spacer);
									let player1 = document.createElement('div');
									player1.classList.add('player', `${match.player1.toLowerCase()}`);
									player1.textContent = match.player1;
									roundMatchesListItem.append(player1);
									let v = document.createElement('div');
									if (matches[0].length) {
										v.classList.add('result');
									}
									v.textContent = 'v';
									roundMatchesListItem.append(v);
									let player2 = document.createElement('div');
									player2.classList.add('player', `${match.player2.toLowerCase()}`);
									player2.textContent = match.player2;
									roundMatchesListItem.append(player2);
									roundMatchesList.append(roundMatchesListItem);
								});

								seasonRound.append(roundMatchesList);

								if (round.matches.some((match) => match.date)) {
									let roundStandingsHeading = document.createElement('h3');
									roundStandingsHeading.textContent = `${round.header} Standings`;
									seasonRound.append(roundStandingsHeading);
									// iii. Round Standings List <ol>
									let roundStandingsList = document.createElement('ol');

									// - Round Standings List Item(s) <li> ...
									round.roundStandings.forEach((player, idx) => {
										let roundStandingsListItem = document.createElement('li');
										let rank = document.createElement('div');
										rank.textContent = `${idx + 1}.`;
										roundStandingsListItem.append(rank);
										let name = document.createElement('div');
										name.textContent = player.name;
										name.classList.add('player', `${player.name.toLowerCase()}`);
										roundStandingsListItem.append(name);
										let record = document.createElement('div');
										record.textContent = `(${player.wins}-${player.losses})`;
										roundStandingsListItem.append(record);
										let points = document.createElement('div');
										points.textContent = `${player.matchPoints} MP`;
										roundStandingsListItem.append(points);
										let packs = document.createElement('div');
										packs.textContent = player.packs ? `[+${player.packs} packs]` : '';
										roundStandingsListItem.append(packs);
										roundStandingsList.append(roundStandingsListItem);
									});

									seasonRound.append(roundStandingsList);
								}
								seasonRounds.append(seasonRound);
							});

							leagueSeason.append(seasonRounds);
							leagueSeasons.append(leagueSeason);
						});

						body.append(leagueSeasons);
					}
					buildPage();
				});
		</script>
	</body>
</html>
